# =============================================================================
# Module Workflow: Port Scanning
# =============================================================================

kind: module

name: portscan

description: Quick port scan for all ports

tags: portscan, rustscan, network

# -----------------------------------------------------------------------------
# PARAMS SECTION
# -----------------------------------------------------------------------------
params:
  - name: nonCdnFile
    default: "{{Output}}/ipspace/{{TargetSpace}}-noncdn.txt"

  - name: openPortsFile
    default: "{{Output}}/portscan/open-ports-{{TargetSpace}}.txt"

  - name: httpPortFingerprintJsonlFile
    default: "{{Output}}/portscan/http-port-fingerprint-{{TargetSpace}}.jsonl"

  - name: httpPortFingerprintFilteredJsonlFile
    default: "{{Output}}/portscan/http-port-fingerprint-filtered-{{TargetSpace}}.jsonl"

  - name: httpPortFingerprintMarkdownFile
    default: "{{Output}}/portscan/http-port-fingerprint-filtered-{{TargetSpace}}.md"

  - name: commonHttpPorts
    default: "3000,5000,8000,8008,8081,8082,8083,8088,8888"
  - name: commonHttpsPort
    default: "8443"

  # - name: rateRustScan
  #   default: "{{ threads * 400 }}"
  - name: httpThreads
    default: "{{ threads * 3 }}"
  - name: httpTimeout
    default: "15"
  - name: defaultUA
    default: "User-Agent: Mozilla/5.0 (compatible; Osmedeus/v5; +https://github.com/j3ssie/osmedeus)"

  # - name: screenThreads
  #   default: "{{ threads * 2}}"
  # - name: skipPortScreenShot
  #   default: "false"

# -----------------------------------------------------------------------------
# DEPENDENCIES SECTION
# -----------------------------------------------------------------------------
dependencies:
  commands:
    - httpx

  variables:
    - name: Target
      type: string
      required: true

# -----------------------------------------------------------------------------
# REPORTS SECTION
# -----------------------------------------------------------------------------
reports:
  - name: open-ports
    path: "{{openPortsFile}}"
    type: text
    description: List of open ports

  - name: http-services
    path: "{{httpPortFingerprintJsonlFile}}"
    type: text
    description: HTTP services on open ports

# -----------------------------------------------------------------------------
# STEPS SECTION
# -----------------------------------------------------------------------------
steps:
  # ---------------------------------------------------------------------------
  # Setup: Create output folder
  # ---------------------------------------------------------------------------
  - name: create-output-folder
    type: function
    log: "Creating portscan output folder"
    function: 'createFolder("{{Output}}/portscan")'

  # # ---------------------------------------------------------------------------
  # # Port scanning with rustscan
  # # ---------------------------------------------------------------------------
  # - name: rustscan-port-scan
  #   type: bash
  #   log: "Running port scan with rustscan"
  #   pre_condition: 'fileExists("{{nonCdnFile}}")'
  #   command: '{{Binaries}}/rustscan --timeout 3000 -b {{rateRustScan}} --scripts None --range {{ports}} -a {{nonCdnFile}} -g >> {{Output}}/portscan/raw-open-ports.txt'
  # - name: clean-rustscan-results
  #   type: function
  #   log: "Cleaning rustscan results"
  #   function: 'CleanRustScan("{{Output}}/portscan/raw-open-ports.txt", "{{Output}}/portscan/open-ports.txt")'

  # ---------------------------------------------------------------------------
  # HTTP probing on open ports
  # ---------------------------------------------------------------------------
  - name: http-probe-ports
    type: bash
    log: "Probing for HTTP services on open ports"
    pre_condition: 'fileExists("{{nonCdnFile}}")'
    commands: 
      - cat {{nonCdnFile}} | httpx -H '{{defaultUA}}' -timeout {{httpTimeout}} -t {{httpThreads}} -no-fallback -no-color -silent -json -title -favicon -hash sha256 -jarm -tech-detect -status-code -cdn -tls-grab -ztls -vhost -follow-host-redirects -include-chain -ports 'http:{{commonHttpPorts}},https:{{commonHttpsPort}}' >> {{httpPortFingerprintJsonlFile}}
      - cat {{httpPortFingerprintJsonlFile}} | jq -r '[.host_ip,.port] | join(\":\")' | sort -u >> {{openPortsFile}}
    on_error: 
      - action: continue # expected error if no port found

  - name: sort-http-results
    type: function
    log: "Sorting HTTP probe results"
    pre_condition: 'fileExists("{{httpPortFingerprintJsonlFile}}")'
    functions:
      - jsonl_filter("{{httpPortFingerprintJsonlFile}}", "{{httpPortFingerprintFilteredJsonlFile}}", "url,title,status_code,content_length,lines,webserver,tech,cdn")
      - 'convert_jsonl_to_markdown("{{httpPortFingerprintFilteredJsonlFile}}", "{{httpPortFingerprintMarkdownFile}}")'

