# =============================================================================
# Module Workflow: HTTP Fingerprinting
# =============================================================================
kind: module
name: fingerprint
description: Fingerprint HTTP technology and response
tags: fingerprint, technology, http

# -----------------------------------------------------------------------------
# PARAMS SECTION
# -----------------------------------------------------------------------------
params:
  - name: httpFile
    default: "{{Output}}/probing/http-{{TargetSpace}}.txt"

  - name: httpInterestingFile
    default: "{{Output}}/fingerprint/http-interesting-{{TargetSpace}}.txt"

  - name: httpFingerprintJsonFile
    default: "{{Output}}/fingerprint/http-fingerprint-{{TargetSpace}}.jsonl"

  - name: httpInterestingJsonFile
    default: "{{Output}}/fingerprint/http-interesting-{{TargetSpace}}.jsonl"

  - name: httpInterestingFilteredJsonFile
    default: "{{Output}}/fingerprint/http-interesting-filtered-{{TargetSpace}}.jsonl"

  - name: httpInterestingMarkdownFile
    default: "{{Output}}/fingerprint/http-interesting-filtered-{{TargetSpace}}.md"

  - name: httpThreads
    default: "{{ threads * 2 }}"

  - name: httpTimeout
    default: "15"

  - name: defaultUA
    default: "User-Agent: Mozilla/5.0 (compatible; Osmedeus/v5; +https://github.com/j3ssie/osmedeus)"

# -----------------------------------------------------------------------------
# DEPENDENCIES SECTION
# -----------------------------------------------------------------------------
dependencies:
  commands:
    - httpx

  variables:
    - name: Target
      type: string
      required: true

reports:
  - name: http-data
    path: "{{httpFingerprintJsonFile}}"
    type: jsonl
    description: HTTP fingerprinting data

  - name: httpInterestingMarkdownFile
    default: "{{Output}}/fingerprint/http-interesting-{{TargetSpace}}.md"
    type: markdown
    description: HTTP Fingerprinting Results with Interesting HTTP Responses

# -----------------------------------------------------------------------------
# STEPS SECTION
# -----------------------------------------------------------------------------
steps:
  # ---------------------------------------------------------------------------
  # Setup: Create output folder
  # ---------------------------------------------------------------------------
  - name: create-output-folder
    type: function
    log: "Creating fingerprint output folder"
    function: 'createFolder("{{Output}}/fingerprint")'

  # ---------------------------------------------------------------------------
  # HTTP fingerprinting with httpx
  # ---------------------------------------------------------------------------
  - name: http-fingerprint
    type: bash
    log: "Fingerprinting HTTP hosts with httpx"
    pre_condition: 'fileExists("{{httpFile}}")'
    command: 'cat {{httpFile}} | httpx -H "{{defaultUA}}" -timeout {{httpTimeout}} -t {{httpThreads}} -no-fallback -no-color -silent -json -title -favicon -hash sha256 -jarm -tech-detect -status-code -cdn -tls-grab -ztls -vhost -follow-host-redirects -include-chain >> {{httpFingerprintJsonFile}}'

  - name: create-unique-jsonl
    type: function
    log: "Creating unique HTTP file based on host, status code, and body SHA256"
    functions:
      - jsonl_unique("{{httpFingerprintJsonFile}}", "{{httpInterestingJsonFile}}", "host,status,hash.body_sha256")
      - exec_cmd("cat {{httpInterestingJsonFile}} | jq -r '.url' > {{httpInterestingFile}}")

  - name: fallback-interesting-http
    type: function
    log: "Creating HTTP interesting if we can't unique the hash"
    pre_condition: '!fileExists("{{httpInterestingFile}}")'
    functions:
      - exec_cmd("cp {{httpFile}} {{httpInterestingFile}}")

  - name: beautify-interesting-http-results
    type: function
    log: "Beautifying interesting HTTP results"
    pre_condition: 'fileExists("{{httpInterestingJsonFile}}")'
    functions:
      - jsonl_filter("{{httpInterestingJsonFile}}", "{{httpInterestingFilteredJsonFile}}", "url,title,status_code,content_length,lines,webserver,tech,cdn")
      - 'convert_jsonl_to_markdown("{{httpInterestingFilteredJsonFile}}", "{{httpInterestingMarkdownFile}}")'

  - name: process-fingerprint-results
    type: function
    log: "Processing fingerprint results"
    functions:
      - 'db_total_urls("{{httpFingerprintJsonFile}}")'
      - 'db_total_assets("{{httpFingerprintJsonFile}}")'
