# =============================================================================
# Module Workflow: Web Spidering
# =============================================================================

kind: module
name: spider
description: Crawling links in http site
tags: spider, crawl, links, secrets

# -----------------------------------------------------------------------------
# PARAMS SECTION
# -----------------------------------------------------------------------------
params:
  - name: httpInterestingFile
    default: "{{Output}}/fingerprint/http-interesting-{{TargetSpace}}.txt"

  - name: linkFile
    default: "{{Output}}/links/links-{{TargetSpace}}.txt"
  - name: httpResponse
    default: "{{Output}}/http-response/"

  - name: spiderTimeout
    default: "2h"
  - name: spiderThreads
    default: "{{ threads }}"
  - name: spiderPrallel
    default: "{{ threads / 2 }}"
  - name: spiderDepth
    default: "3"
  - name: crawlingTime
    default: "30"

  - name: skipSpidering
    type: bool
    default: false
  - name: defaultUA
    default: "User-Agent: Mozilla/5.0 (compatible; Osmedeus/v5; +https://github.com/j3ssie/osmedeus)"

  - name: trufflehogThreads
    default: "{{ threads * 6}}"

  - name: httpThreads
    default: "{{ threads * 10}}"

# -----------------------------------------------------------------------------
# DEPENDENCIES SECTION
# -----------------------------------------------------------------------------
dependencies:
  commands:
    - katana
    - httpx
    - trufflehog

  variables:
    - name: Target
      type: string
      required: true

# -----------------------------------------------------------------------------
# REPORTS SECTION
# -----------------------------------------------------------------------------
reports:
  - name: links
    path: "{{Output}}/links/links-{{TargetSpace}}.txt"
    type: text
    description: Discovered links

  - name: trufflehog-output
    path: "{{Output}}/secrets/trufflehog-{{TargetSpace}}-output.txt"
    type: text
    description: Trufflehog secrets scan output

# -----------------------------------------------------------------------------
# STEPS SECTION
# -----------------------------------------------------------------------------
steps:
  # ---------------------------------------------------------------------------
  # Setup: Create output folder
  # ---------------------------------------------------------------------------
  - name: create-output-folder
    type: function
    log: "Creating links output folder"
    functions:
      - 'createFolder("{{Output}}/links")'
      - 'createFolder("{{Output}}/secrets")'

  # ---------------------------------------------------------------------------
  # Check skip condition
  # ---------------------------------------------------------------------------
  - name: check-skip-spidering
    type: function
    log: "Checking if spidering should be skipped"
    pre_condition: '"{{skipSpidering}}" == "true"'
    functions:
      - 'log_error("Filter", "Skipping spidering")'
      - 'exit(1)'

  # ---------------------------------------------------------------------------
  # Web crawling with Katana
  # ---------------------------------------------------------------------------
  - name: web-crawling
    type: foreach
    log: "Crawling web pages with Katana"
    pre_condition: 'fileExists("{{httpInterestingFile}}")'
    input: "{{httpInterestingFile}}"
    variable: line
    threads: "{{spiderPrallel}}"
    step:
      name: katana-single-target
      type: bash
      command: 'timeout -k 1m {{spiderTimeout}} katana -c {{spiderThreads}} -jc -ct {{crawlingTime}} -u [[line]] | sort -u >> {{linkFile}}'

  # ---------------------------------------------------------------------------
  # Get HTTP responses and scan for secrets
  # ---------------------------------------------------------------------------
  - name: fetch-responses-and-scan-secrets
    type: bash
    log: "Fetching HTTP responses and scanning for secrets with trufflehog"
    commands:
      - "cat {{linkFile}} | {{Binaries}}/httpx -silent -nf -no-color -title -t {{httpThreads}} -H '{{defaultUA}}' --store-response-dir {{httpResponse}}"
      - "trufflehog --concurrency={{trufflehogThreads}} filesystem {{httpResponse}} > {{Output}}/secrets/trufflehog-{{TargetSpace}}-output.txt 2>&1"

  # # ---------------------------------------------------------------------------
  # # Print results if not too large
  # # ---------------------------------------------------------------------------
  # - name: print-results
  #   type: function
  #   log: "Printing link results"
  #   pre_condition: 'fileLength("{{linkFile}}") < 10000'
  #   function: 'cat("{{linkFile}}")'
